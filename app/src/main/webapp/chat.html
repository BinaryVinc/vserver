<!DOCTYPE html>
<html lang="en">
<head>
    <title>Matrix Admin</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/bootstrap-responsive.min.css"/>
    <link rel="stylesheet" href="css/matrix-style.css"/>
    <link rel="stylesheet" href="css/matrix-media.css"/>
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800' rel='stylesheet' type='text/css'>
</head>
<body>

<div id="header">
    <h1><a href="dashboard.html">Matrix Admin</a></h1>
</div>
<div id="user-nav" class="navbar navbar-inverse">
    <ul class="nav">
        <li class="dropdown" id="profile-messages"><a title="" href="#" data-toggle="dropdown"
                                                      data-target="#profile-messages" class="dropdown-toggle"><i
                class="icon icon-user"></i> <span class="text">Welcome User</span><b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a href="#"><i class="icon-user"></i> My Profile</a></li>
                <li class="divider"></li>
                <li><a href="#"><i class="icon-check"></i> My Tasks</a></li>
                <li class="divider"></li>
                <li><a href="login.html"><i class="icon-key"></i> Log Out</a></li>
            </ul>
        </li>
        <li class="dropdown" id="menu-messages"><a href="#" data-toggle="dropdown" data-target="#menu-messages"
                                                   class="dropdown-toggle"><i class="icon icon-envelope"></i> <span
                class="text">Messages</span> <span class="label label-important">5</span> <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a class="sAdd" title="" href="#"><i class="icon-plus"></i> new message</a></li>
                <li class="divider"></li>
                <li><a class="sInbox" title="" href="#"><i class="icon-envelope"></i> inbox</a></li>
                <li class="divider"></li>
                <li><a class="sOutbox" title="" href="#"><i class="icon-arrow-up"></i> outbox</a></li>
                <li class="divider"></li>
                <li><a class="sTrash" title="" href="#"><i class="icon-trash"></i> trash</a></li>
            </ul>
        </li>
        <li class=""><a title="" href="#"><i class="icon icon-cog"></i> <span class="text">Settings</span></a></li>
        <li class=""><a title="" href="login.html"><i class="icon icon-share-alt"></i> <span class="text">Logout</span></a>
        </li>
    </ul>
</div>
<div id="search">
    <input type="text" placeholder="Search here..."/>
    <button type="submit" class="tip-bottom" title="Search"><i class="icon-search icon-white"></i></button>
</div>
<div id="sidebar">
    <ul>
        <li><a href="index.html"><i class="icon icon-home"></i> <span>+</span></a></li>
        <li><a href="charts.html"><i class="icon icon-signal"></i> <span>Charts &amp; graphs</span></a></li>
        <li><a href="widgets.html"><i class="icon icon-inbox"></i> <span>Widgets</span></a></li>
        <li><a href="tables.html"><i class="icon icon-th"></i> <span>Tables</span></a></li>
        <li><a href="grid.html"><i class="icon icon-fullscreen"></i> <span>Full width</span></a></li>
        <li class="submenu"><a href="#"><i class="icon icon-th-list"></i> <span>Forms</span> <span
                class="label label-important">3</span></a>
            <ul>
                <li><a href="form-common.html">Basic Form</a></li>
                <li><a href="form-validation.html">Form with Validation</a></li>
                <li><a href="form-wizard.html">Form with Wizard</a></li>
            </ul>
        </li>
        <li><a href="buttons.html"><i class="icon icon-tint"></i> <span>Buttons &amp; icons</span></a></li>
        <li><a href="interface.html"><i class="icon icon-pencil"></i> <span>Eelements</span></a></li>
        <li class="submenu active"><a href="#"><i class="icon icon-file"></i> <span>Addons</span> <span
                class="label label-important">5</span></a>
            <ul>
                <li><a href="index2.html">Dashboard2</a></li>
                <li><a href="gallery.html">Gallery</a></li>
                <li><a href="calendar.html">Calendar</a></li>
                <li><a href="invoice.html">Invoice</a></li>
                <li><a href="chat.html">Chat option</a></li>
            </ul>
        </li>
        <li class="submenu"><a href="#"><i class="icon icon-info-sign"></i> <span>Error</span> <span
                class="label label-important">4</span></a>
            <ul>
                <li><a href="error403.html">Error 403</a></li>
                <li><a href="error404.html">Error 404</a></li>
                <li><a href="error405.html">Error 405</a></li>
                <li><a href="error500.html">Error 500</a></li>
            </ul>
        </li>
        <li class="content"><span>Monthly Bandwidth Transfer</span>
            <div class="progress progress-mini progress-danger active progress-striped">
                <div style="width: 77%;" class="bar"></div>
            </div>
            <span class="percent">77%</span>
            <div class="stat">21419.94 / 14000 MB</div>
        </li>
        <li class="content"><span>Disk Space Usage</span>
            <div class="progress progress-mini active progress-striped">
                <div style="width: 87%;" class="bar"></div>
            </div>
            <span class="percent">87%</span>
            <div class="stat">604.44 / 4000 MB</div>
        </li>
    </ul>
</div>
<div id="content">
    <div id="content-header">
        <div id="breadcrumb"><a href="#" title="Go to Home" class="tip-bottom"><i class="icon-home"></i> Home</a> <a
                href="#">Sample pages</a> <a href="#" class="current">Chat option</a></div>
        <h1>Chat option</h1>
    </div>
    <div class="container-fluid">
        <hr>
        <div class="row-fluid">
            <div class="span12">
                <div class="widget-box widget-chat">
                    <div class="widget-title"><span class="icon"> <i class="icon-comment"></i> </span>
                        <h5>Let's do a chat</h5>
                    </div>
                    <div class="widget-content nopadding">
                        <div class="chat-users panel-right2">
                            <div class="panel-title">
                                <h5>Online Users</h5>
                            </div>
                            <div class="panel-content nopadding">
                                <ul class="contact-list">
                                    <!--<li id="user-Alex" class="online"><a href="#"><img alt="" src="img/demo/av1.jpg"/>-->
                                        <!--<span>Alex</span></a></li>-->
                                    <!--<li id="user-Linda"><a href="#"><img alt="" src="img/demo/av2.jpg"/>-->
                                        <!--<span>Linda</span></a></li>-->
                                    <!--<li id="user-John" class="online new"><a href="#"><img alt=""-->
                                                                                           <!--src="img/demo/av3.jpg"/>-->
                                        <!--<span>John</span></a><span class="msg-count badge badge-info">3</span></li>-->
                                    <!--<li id="user-Mark" class="online"><a href="#"><img alt="" src="img/demo/av4.jpg"/>-->
                                        <!--<span>Mark</span></a></li>-->
                                    <!--<li id="user-Maxi" class="online"><a href="#"><img alt="" src="img/demo/av5.jpg"/>-->
                                        <!--<span>Maxi</span></a></li>-->
                                </ul>
                            </div>
                        </div>
                        <div class="chat-content panel-left2">
                            <div class="chat-messages" id="chat-messages">
                                <div id="chat-messages-inner"></div>
                            </div>
                            <div class="chat-message well">
                                <button class="btn btn-success">Send</button>
                <span class="input-box">
                <input type="text" name="msg-box" id="msg-box"/>
                </span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div id="footer" class="span12"> 2013 &copy; Matrix Admin. Brought to you by <a href="http://themedesigner.in/">Themedesigner.in</a>
    </div>
</div>
<script src="js/jquery.min.js"></script>
<script src="js/jquery.ui.custom.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/matrix.js"></script>
<!--<script src="js/matrix.chat.js"></script>-->
<script src="js/common.js"></script>
<script src="js/cool.js"></script>
<script>
    $(function () {

//        cool.room.create({name:"it"},function (msgSet) {
//            console.log(msgSet)
//        })

//        var data = {name:"jack",gender:1};
//        cool.user.auth(data, function (msgSet) {
//            console.log(msgSet);
//        })


        var msg_template = '<p><span class="msg-block"><strong></strong><span class="time"></span><span class="msg"></span></span></p>';

        $('.chat-message button').click(function () {
            var input = $(this).siblings('span').children('input[type=text]');
            if (input.val() != '') {
                websocket.send(input.val());
//                add_message('You','img/demo/av1.jpg',input.val(),true);
            }
        });

//        $('.chat-message input').keypress(function(e){
//            if(e.which == 13) {
//                if($(this).val() != ''){
//                    websocket.send($(this).val());
////                    add_message('You','img/demo/av1.jpg',$(this).val(),true);
//                }
//            }
//        });

//        setTimeout(function(){
//            add_message('Linda','img/demo/av2.jpg','Hello Every one do u want to freindship with me?')
//        },'1000');
//        setTimeout(function(){
//            add_message('Mark','img/demo/av3.jpg','Yuppi! why not sirji!!.')
//        },'4000');
//        setTimeout(function(){
//            add_message('Linda','img/demo/av2.jpg','Thanks!!! See you soon than')
//        },'8000');
//        setTimeout(function(){
//            add_message('Mark','img/demo/av3.jpg','ok Bye than!!!.')
//        },'12000');
//        setTimeout(function(){
//            remove_user('Linda','Linda')
//        },'16000');
        var i = 0;

        function add_message(name, img, msg, clear, date) {
            i = i + 1;
            var inner = $('#chat-messages-inner');
//            var time = new Date();
//            var hours = time.getHours();
//            var minutes = time.getMinutes();
//            if (hours < 10) hours = '0' + hours;
//            if (minutes < 10) minutes = '0' + minutes;
            if (!date)
                date = '';
            var id = 'msg-' + i;
            var idname = name.replace(' ', '-').toLowerCase();
            inner.append('<p id="' + id + '" class="user-' + idname + '">'
                    + '<span class="msg-block"><img src="' + img + '" alt="" /><strong>' + name + '</strong> <span class="time"> ' + date + '</span>'
                    + '<span class="msg">' + msg + '</span></span></p>');
            $('#' + id).hide().fadeIn(800);
            if (clear) {
                $('.chat-message input').val('').focus();
            }
            $('#chat-messages').animate({scrollTop: inner.height()}, 1000);
        }

        function remove_user(userid, name) {
            i = i + 1;
            $('.contact-list li#user-' + userid).addClass('offline').delay(1000).slideUp(800, function () {
                $(this).remove();
            });
            var inner = $('#chat-messages-inner');
            var id = 'msg-' + i;
            inner.append('<p class="offline" id="' + id + '"><span>User ' + name + ' left the chat</span></p>');
            $('#' + id).hide().fadeIn(800);
        }

        function add_user(userid, name, img) {
            i = i + 1;

            var ulist = '<li id="user-"+'+userid+' class="online"><a href="#"><img alt="" src="'+img+'"/><span>'+name+'</span></a></li>'

            $('.contact-list').append(ulist);

//            $('.contact-list li#user-' + userid).addClass('offline').delay(1000).slideUp(800, function () {
//                $(this).remove();
//            });
//            var inner = $('#chat-messages-inner');
//            var id = 'msg-' + i;
//            inner.append('<p class="offline" id="' + id + '"><span>User ' + name + ' left the chat</span></p>');
//            $('#' + id).hide().fadeIn(800);
        }

        var websocket = null;
        //判断当前浏览器是否支持WebSocket
        if ('WebSocket' in window) {
            websocket = new WebSocket("ws://127.0.0.1:8080/ws?rid=" + -1660492593 + "&uid=" + -373118128);
        } else {
            alert('当前浏览器 Not support websocket')
        }

        //连接发生错误的回调方法
        websocket.onerror = function () {
//            setMessageInnerHTML("WebSocket连接发生错误");
        };

        //连接成功建立的回调方法
        websocket.onopen = function (data1) {
//            setMessageInnerHTML("进入房间");
        }

        //接收到消息的回调方法
        websocket.onmessage = function (event) {
            var msg = JSON.parse(event.data);
            var img = msg.gender == 0 ? 'img/demo/av3.jpg' : 'img/demo/av4.jpg'
            add_message(msg.uname, img, msg.msg, true, msg.date);

            if(msg.oper == 1){
                add_user(msg.uid,msg.uname,img);
            }
            if(msg.oper == 2){

            }


        }

        //连接关闭的回调方法
        websocket.onclose = function () {
//            setMessageInnerHTML("离开房间");
        }

        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            closeWebSocket();
        }

        //将消息显示在网页上
//        function setMessageInnerHTML(innerHTML) {
//            add_message('You', 'img/demo/av1.jpg', innerHTML, true);
////            document.getElementById('message').innerHTML += innerHTML + '<br/>';
//        }

        //关闭WebSocket连接
        function closeWebSocket() {
            websocket.close();
        }

        //发送消息
        function send() {
            var message = document.getElementById('text').value;
            websocket.send(message);
        }

    })

</script>
</body>
</html>
