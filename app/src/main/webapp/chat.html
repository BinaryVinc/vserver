<!DOCTYPE html>
<html lang="en">
<head>
    <title>chat</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/bootstrap-responsive.min.css"/>
    <link rel="stylesheet" href="css/matrix-style.css"/>
    <link rel="stylesheet" href="css/matrix-media.css"/>
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800' rel='stylesheet' type='text/css'>
</head>
<body>

<div id="header">
    <h1><a href="dashboard.html">Matrix Admin</a></h1>
</div>
<div id="user-nav" class="navbar navbar-inverse">
    <ul class="nav">
        <li class="dropdown" id="profile-messages"><a title="" href="#" data-toggle="dropdown"
                                                      data-target="#profile-messages" class="dropdown-toggle"><i
                class="icon icon-user"></i> <span class="text">Welcome User</span><b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a href="#"><i class="icon-user"></i> My Profile</a></li>
                <li class="divider"></li>
                <li><a href="#"><i class="icon-check"></i> My Tasks</a></li>
                <li class="divider"></li>
                <li><a href="login.html"><i class="icon-key"></i> Log Out</a></li>
            </ul>
        </li>
        <li class="dropdown" id="menu-messages"><a href="#" data-toggle="dropdown" data-target="#menu-messages"
                                                   class="dropdown-toggle"><i class="icon icon-envelope"></i> <span
                class="text">Messages</span> <span class="label label-important">5</span> <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a class="sAdd" title="" href="#"><i class="icon-plus"></i> new message</a></li>
                <li class="divider"></li>
                <li><a class="sInbox" title="" href="#"><i class="icon-envelope"></i> inbox</a></li>
                <li class="divider"></li>
                <li><a class="sOutbox" title="" href="#"><i class="icon-arrow-up"></i> outbox</a></li>
                <li class="divider"></li>
                <li><a class="sTrash" title="" href="#"><i class="icon-trash"></i> trash</a></li>
            </ul>
        </li>
        <li class=""><a title="" href="#"><i class="icon icon-cog"></i> <span class="text">Settings</span></a></li>
        <li class=""><a title="" href="login.html"><i class="icon icon-share-alt"></i> <span class="text">Logout</span></a>
        </li>
    </ul>
</div>
<div id="search">
    <input type="text" placeholder="Search here..."/>
    <button type="submit" class="tip-bottom" title="Search"><i class="icon-search icon-white"></i></button>
</div>
<div id="sidebar">
    <ul>
        <li><a href="#"><i class="icon icon-signal"></i> <span>创建房间</span></a></li>
    </ul>
</div>
<div id="content">
    <div id="content-header">
        <div id="breadcrumb"><a href="#" title="Go to Home" class="tip-bottom"><i class="icon-home"></i> Home</a></div>
        <h1 id="chat-id">Chat option</h1>
    </div>
    <div class="container-fluid">
        <hr>
        <div class="row-fluid">
            <div class="span12">
                <div class="widget-box widget-chat">
                    <div class="widget-title"><span class="icon"> <i class="icon-comment"></i> </span>
                        <h5>Let's do a chat</h5>
                    </div>
                    <div class="widget-content nopadding">
                        <div class="chat-users panel-right2">
                            <div class="panel-title">
                                <h5>Users</h5>
                            </div>
                            <div class="panel-content nopadding">
                                <ul class="contact-list">
                                </ul>
                            </div>
                        </div>
                        <div class="chat-content panel-left2">
                            <div class="chat-messages" id="chat-messages">
                                <div id="chat-messages-inner"></div>
                            </div>
                            <div class="chat-message well">
                                <button class="btn btn-success">Send</button>
                            <span class="input-box">
                            <input type="text" name="msg-box" id="msg-box"/>
                            </span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row-fluid">
    <div id="footer" class="span12"><a href="https://github.com/BinaryVinc/vserver/tree/chat-room">github@BinaryVinc</a>
    </div>
</div>
<script src="js/jquery.min.js"></script>
<script src="js/jquery.ui.custom.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/matrix.js"></script>
<script src="js/common.js"></script>
<script src="js/cool.js"></script>
<script>


    $(function () {

        cool.room.list({}, function (msg) {
            var json = JSON.parse(msg);
            if (!json.res)
                return;
            var rrids = json.res;
            var li = '';
            for (var j = 0; j < rrids.length; j++) {
                var rn = rrids[j].split("_");
                li += '<li><a href="chat.html?rid=' + rn[0] + '"  id="room_' + rn[0] + '"><i class="icon icon-signal"></i> <span>' + rn[1] + '</span></a></li>';
            }
            $("#sidebar ul").append(li);
        })

        $('.chat-message button').click(function () {
            var input = $(this).siblings('span').children('input[type=text]');
            if (input.val() != '') {
                websocket.send(input.val());
            }
        });

        $('.chat-message input').keypress(function (e) {
            if (e.which == 13) {
                if ($(this).val() != '') {
                    websocket.send($(this).val());
                }
            }
        });

        var i = 0;
        function add_message(name, img, msg, clear, date) {
            i = i + 1;
            var inner = $('#chat-messages-inner');
            if (!date)
                date = '';
            var id = 'msg-' + i;
            var idname = name.replace(' ', '-').toLowerCase();
            inner.append('<p id="' + id + '" class="user-' + idname + '">'
                    + '<span class="msg-block"><img src="' + img + '" alt="" /><strong>' + name + '</strong> <span class="time"> ' + date + '</span>'
                    + '<span class="msg">' + msg + '</span></span></p>');
            $('#' + id).hide().fadeIn(80);
            if (clear) {
                $('.chat-message input').val('').focus();
            }
            $('#chat-messages').animate({scrollTop: inner.height()}, 100);
        }

        function remove_user(userid, name) {
            i = i + 1;
            var inner = $('#chat-messages-inner');
            var id = 'msg-' + i;
            inner.append('<p class="offline" id="' + id + '"><span>' + name + ' left</span></p>');
            $('#chat-messages').animate({scrollTop: inner.height()}, 100);
        }

        function add_user(userid, name, img) {
            i = i + 1;
            var inner = $('#chat-messages-inner');
            var id = 'msg-' + i;
            console.log(id)
            inner.append('<p class="offline" id="' + id + '"><span>' + name + ' join</span></p>');
            $('#chat-messages').animate({scrollTop: inner.height()}, 100);
        }

        var roomid = gqs("rid");
        cool.room.olds({rid: roomid}, function (msg) {
            var oldmsg = JSON.parse(msg).res;
            for (var j = oldmsg.length -1 ; j > 0; j--) {
                var old = JSON.parse(oldmsg[j]);
                if(old.oper == 1 || old.oper == 2)
                        continue;
                var img = old.gender == 0 ? 'img/demo/av3.jpg' : 'img/demo/av4.jpg'
                add_message(old.uname, img, old.msg, true, old.dateStr);
            }
        });

        var websocket = null;
        cool.room.get({rid: roomid}, function (msg) {
            var json = JSON.parse(msg).res;
            $("#chat-id").html(json.rname)
            $("#room_" + roomid).parent().addClass("active");
            if ('WebSocket' in window) {
                websocket = new WebSocket("ws://127.0.0.1:8080/ws?rid=" + roomid);
            } else {
                alert('当前浏览器 Not support websocket')
            }

            websocket.onerror = function () {
                console.log("websocket error.")
            };

            websocket.onopen = function () {
                console.log("websocket open.")
            }

            //接收到消息的回调方法
            websocket.onmessage = function (event) {
                var msg = JSON.parse(event.data);

                var img = msg.gender == 0 ? 'img/demo/av3.jpg' : 'img/demo/av4.jpg'
                if (msg.oper == 0) {
                    add_message(msg.uname, img, msg.msg, true, msg.dateStr);
                }
                if (msg.oper == 1) {
                    var ulist = msg.uList;
                    var inner = $('.contact-list');
                    inner.html('');
                    var lis = '';
                    for (var j = 0; j < ulist.length; j++) {
                        var user = JSON.parse(ulist[j]);
                        var imgU = user.gender == 0 ? 'img/demo/av3.jpg' : 'img/demo/av4.jpg'
                        lis += '<li id="user-' + user.id + '" class="online"><a href="#"><img alt="" src="' + imgU + '"/><span>' + user.name + '</span></a></li>';
                    }
                    inner.append(lis);
                    add_user(msg.uid, msg.uname, img);
                }
                if (msg.oper == 2) {
                    remove_user(msg.uid, msg.uname, img);

                }
            }

            websocket.onclose = function () {
                console.log("websocket close.")
            }

            window.onbeforeunload = function () {
                console.log("window onbeforeunload.")
                closeWebSocket();
            }

            function closeWebSocket() {
                websocket.close();
            }
        })

        function gqs(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)return unescape(r[2]);
            return null;
        }
    })




</script>
</body>
</html>
